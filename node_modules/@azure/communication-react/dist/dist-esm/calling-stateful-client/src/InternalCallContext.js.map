{"version":3,"file":"InternalCallContext.js","sourceRoot":"","sources":["../../../../preprocess-dist/calling-stateful-client/src/InternalCallContext.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\n\nimport { LocalVideoStream, RemoteVideoStream, VideoStreamRenderer } from '@azure/communication-calling';\nimport { LocalVideoStreamState } from './CallClientState';\nimport { CallIdHistory } from './CallIdHistory';\n\n/**\n * Internally tracked render status. Stores the status of a video render of a stream as rendering could take a long\n * time.\n *\n * 'NotRendered' - the stream has not yet been rendered\n * 'Rendering' - the stream is currently rendering\n * 'Rendered' - the stream has been rendered\n * 'Stopping' - the stream is currently rendering but has been signaled to stop\n */\nexport type RenderStatus = 'NotRendered' | 'Rendering' | 'Rendered' | 'Stopping';\n\n/**\n * Internal container to hold common state needed to keep track of renders.\n */\nexport interface RenderInfo {\n  status: RenderStatus;\n  renderer: VideoStreamRenderer | undefined;\n}\n\n/**\n * Internally used to keep track of the status, renderer, and awaiting promise, associated with a LocalVideoStream.\n */\nexport interface LocalRenderInfo extends RenderInfo {\n  stream: LocalVideoStream;\n}\n\n/**\n * Internally used to keep track of the status, renderer, and awaiting promise, associated with a RemoteVideoStream.\n */\nexport interface RemoteRenderInfo extends RenderInfo {\n  stream: RemoteVideoStream;\n}\n\n/**\n * Contains internal data used between different Declarative components to share data.\n */\nexport class InternalCallContext {\n  // <CallId, <ParticipantKey, <StreamId, RemoteRenderInfo>>\n  private _remoteRenderInfos = new Map<string, Map<string, Map<number, RemoteRenderInfo>>>();\n\n  // <CallId, LocalRenderInfo>.\n  private _localRenderInfos = new Map<string, LocalRenderInfo>();\n\n  // Used for keeping track of rendered LocalVideoStreams that are not part of a Call.\n  // The key is the stream ID. We assume each stream ID to only have one owning render info\n  private _unparentedRenderInfos = new Map<string, LocalRenderInfo>();\n  private _callIdHistory = new CallIdHistory();\n  public setCallId(newCallId: string, oldCallId: string): void {\n    this._callIdHistory.updateCallIdHistory(newCallId, oldCallId);\n    const remoteRenderInfos = this._remoteRenderInfos.get(oldCallId);\n    if (remoteRenderInfos) {\n      this._remoteRenderInfos.delete(oldCallId);\n      this._remoteRenderInfos.set(newCallId, remoteRenderInfos);\n    }\n    const localRenderInfos = this._localRenderInfos.get(oldCallId);\n    if (localRenderInfos) {\n      this._localRenderInfos.delete(oldCallId);\n      this._localRenderInfos.set(newCallId, localRenderInfos);\n    }\n  }\n  public getCallIds(): IterableIterator<string> {\n    return this._remoteRenderInfos.keys();\n  }\n  public getRemoteRenderInfoForCall(callId: string): Map<string, Map<number, RemoteRenderInfo>> | undefined {\n    return this._remoteRenderInfos.get(this._callIdHistory.latestCallId(callId));\n  }\n  public getRemoteRenderInfoForParticipant(callId: string, participantKey: string, streamId: number): RemoteRenderInfo | undefined {\n    const callRenderInfos = this._remoteRenderInfos.get(this._callIdHistory.latestCallId(callId));\n    if (!callRenderInfos) {\n      return undefined;\n    }\n    const participantRenderInfos = callRenderInfos.get(participantKey);\n    if (!participantRenderInfos) {\n      return undefined;\n    }\n    return participantRenderInfos.get(streamId);\n  }\n  public setRemoteRenderInfo(callId: string, participantKey: string, streamId: number, stream: RemoteVideoStream, status: RenderStatus, renderer: VideoStreamRenderer | undefined): void {\n    let callRenderInfos = this._remoteRenderInfos.get(this._callIdHistory.latestCallId(callId));\n    if (!callRenderInfos) {\n      callRenderInfos = new Map<string, Map<number, RemoteRenderInfo>>();\n      this._remoteRenderInfos.set(this._callIdHistory.latestCallId(callId), callRenderInfos);\n    }\n    let participantRenderInfos = callRenderInfos.get(participantKey);\n    if (!participantRenderInfos) {\n      participantRenderInfos = new Map<number, RemoteRenderInfo>();\n      callRenderInfos.set(participantKey, participantRenderInfos);\n    }\n    participantRenderInfos.set(streamId, {\n      stream,\n      status,\n      renderer\n    });\n  }\n  public deleteRemoteRenderInfo(callId: string, participantKey: string, streamId: number): void {\n    const callRenderInfos = this._remoteRenderInfos.get(this._callIdHistory.latestCallId(callId));\n    if (!callRenderInfos) {\n      return;\n    }\n    const participantRenderInfos = callRenderInfos.get(participantKey);\n    if (!participantRenderInfos) {\n      return;\n    }\n    participantRenderInfos.delete(streamId);\n  }\n  public setLocalRenderInfo(callId: string, stream: LocalVideoStream, status: RenderStatus, renderer: VideoStreamRenderer | undefined): void {\n    this._localRenderInfos.set(this._callIdHistory.latestCallId(callId), {\n      stream,\n      status,\n      renderer\n    });\n  }\n  public getLocalRenderInfo(callId: string): LocalRenderInfo | undefined {\n    return this._localRenderInfos.get(this._callIdHistory.latestCallId(callId));\n  }\n  public deleteLocalRenderInfo(callId: string): void {\n    this._localRenderInfos.delete(this._callIdHistory.latestCallId(callId));\n  }\n  public getUnparentedRenderInfo(localVideoStream: LocalVideoStreamState): LocalRenderInfo | undefined {\n    return this._unparentedRenderInfos.get(localVideoStream.source.id);\n  }\n  public setUnparentedRenderInfo(statefulStream: LocalVideoStreamState, stream: LocalVideoStream, status: RenderStatus, renderer: VideoStreamRenderer | undefined): void {\n    this._unparentedRenderInfos.set(statefulStream.source.id, {\n      stream,\n      status,\n      renderer\n    });\n  }\n  public deleteUnparentedRenderInfo(localVideoStream: LocalVideoStreamState): void {\n    this._unparentedRenderInfos.delete(localVideoStream.source.id);\n  }\n\n  // UnparentedRenderInfos are not cleared as they are not part of the Call state.\n  public clearCallRelatedState(): void {\n    this._remoteRenderInfos.clear();\n    this._localRenderInfos.clear();\n  }\n}"]}